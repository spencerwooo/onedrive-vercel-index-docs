import Callout from 'nextra-theme-docs/callout'
import Encryption from '../../components/encryption'

# é«˜çº§

<Callout emoji="â™»ï¸">æ­¤é¡µæŒç»­æ›´æ–°ä¸­ã€‚</Callout>

è¿™é‡Œæœ‰äº›é«˜çº§è®¾ç½®ï¼Œä½ å¯èƒ½éœ€è¦äº†è§£ä¸€ä¸‹ã€‚

## ä½¿ç”¨ä½ è‡ªå·±çš„ client id ä¸ secret

å¦‚æœä½ çš„è´¦æˆ·æ²¡æœ‰ç®¡ç†æƒé™ï¼Œé‚£ä¹ˆä½ å°±æ— æ³•ä½¿ç”¨é¡¹ç›®æä¾›çš„ `clientId` ä¸ `clientSecret`ã€‚è¿™ä¸ªæƒ…å†µä¸‹ï¼Œä½ å°±è¦ç”Ÿæˆä½ è‡ªå·±çš„ client id ä¸ secret äº†ã€‚

### æ³¨å†Œä¸€ä¸ªåº”ç”¨ç¨‹åº

æ‰“å¼€ä»¥ä¸‹é“¾æ¥ï¼š

- [Microsoft Azure App registrations](https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade)ï¼ˆ OneDrive å›½é™…ç‰ˆã€ä¼ä¸šç‰ˆä¸æ•™è‚²ç‰ˆï¼ŒE5 è®¢é˜…ä¸“ç”¨ï¼‰
- [Microsoft Azure.cn App registrations](https://portal.azure.cn/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade)ï¼ˆOneDrive ä¸–çºªäº’è”ä¸“ç”¨ï¼‰

åˆ›å»ºä¸€ä¸ªåº”ç”¨ç¨‹åºï¼š

1. ç™»å…¥ä½ çš„å¾®è½¯è´¦æˆ·ï¼Œç‚¹å‡» _New registration_ã€‚
2. è¾“å…¥ä¸€ä¸ªåå­—ï¼Œä¾‹å¦‚ my-onedrive-vercel-indexã€‚
3. å°† _Supported account types_ è®¾ç½®ä¸ºï¼š

   ```
   Accounts in any organizational directory (Any Azure AD directory - Multitenant) and personal Microsoft accounts (e.g. Skype, Xbox)
   ```

   OneDrive ä¸–çºªäº’è”ç”¨æˆ·è®¾ç½®ä¸º - ä»»ä½•ç»„ç»‡ç›®å½•ï¼ˆä»»ä½• Azure AD ç›®å½• - å¤šç§Ÿæˆ·ï¼‰ä¸­çš„å¸æˆ·ã€‚

4. å°† _Redirect URI (optional)_ è®¾ç½®ä¸º `Web`ï¼ˆåœ¨ä¸‹æ‹‰èœå•é‡Œï¼‰ä»¥åŠ `http://localhost`ã€‚
5. ç‚¹å‡»æ³¨å†Œã€‚

![Register a new application](./_images/advanced/register-an-application.png)

### è·å–ä½ çš„ client id ä¸ secret

ä½ çš„åº”ç”¨ (client) ID å°±æ˜¯ `api.config.js` é‡Œçš„ `clientId` ï¼Œå®ƒåº”è¯¥å‡ºç°åœ¨ _Overview_ > _Essentials_ã€‚

![Your application (client) ID](./_images/advanced/get-client-id.png)

ä½ çš„ client secret éœ€è¦æ‰‹åŠ¨è·å–

1. ç‚¹å‡» _Certificates & secrets_ã€‚
2. ç‚¹å‡» _New client secret_ã€‚
3. åˆ›å»ºä¸€ä¸ªæ–° secret ï¼Œæè¿°ä¸º `client_secret`ã€‚
4. å°† _Expires_ è®¾ç½®ä¸º `Custom`ã€‚
5. å°† _Start_ ä¸ _End_ è®¾ç½®ä¸ºèƒ½è®¾ç½®çš„æœ€é•¿æ—¶é—´ã€‚

![Generate a client secret](./_images/advanced/create-client-secret.png)

æœ€åï¼Œç‚¹å‡» _Add_ ï¼Œç„¶åå¤åˆ¶ client_secret çš„å€¼å¹¶å¦¥å–„ä¿ç®¡ã€‚ï¼ˆåªæœ‰ä¸€æ¬¡å¤åˆ¶æœºä¼šï¼‰

![Copy your client secret](./_images/advanced/copy-your-client-secret.png)

### ä¿®æ”¹ API æƒé™

Microsoft Graph API å¯ä»¥è®¾ç½® API èŒƒå›´ï¼Œæˆ‘ä»¬åªéœ€è¦ä»¥ä¸‹ä¸‰ä¸ªï¼ˆ `api.config.js` é‡Œè¦æ±‚çš„ï¼‰ï¼š

```
user.read files.read.all offline_access
```

ç‚¹å‡» _API permissions_ï¼Œå†ç‚¹å‡» _Microsoft Graph_ï¼Œå†ç‚¹å‡» _Delegated permissions_ï¼Œç„¶åæœç´¢ï¼š

- User.Readï¼ˆè¿™åº”è¯¥ä¸€å¼€å§‹å°±å‹¾ä¸Šäº†ï¼‰
- Files.Read.All
- offline_access

é€‰æ‹©å…¨éƒ¨ä¸‰ä¸ªå¹¶ç‚¹å‡» _Add permissions_ã€‚

![Modify Microsoft Graph API permissions](./_images/advanced/add-required-permissions.png)

<Callout>ç°åœ¨ï¼Œä½ å°±å‡†å¤‡å¥½ä½ è‡ªå·±çš„ `clientId` ä¸ `clientSecret` äº†ã€‚</Callout>

### ä¿®æ”¹ `api.config.js`

ä½ å¯ä»¥ç›´æ¥å°† `clientId` ä¿®æ”¹ä¸ºä½ è‡ªå·±çš„ `clientId`ã€‚

ä½†æ˜¯ï¼Œclient secret éœ€è¦ä¿å¯†ï¼Œä½ éœ€è¦åœ¨ä¸‹é¢è¿›è¡Œ AES åŠ å¯†ï¼š

<Encryption />

å¡«å†™ client secret åï¼Œä½ åº”è¯¥å¾—åˆ°ä¸€ä¸ªé•¿å¾—åƒè¿™æ ·çš„å­—ç¬¦ä¸²ï¼š

```
U2FsdGVkX1830zo3/pFDqaBCVBb37iLw3WnBDWGF9GIB2f4apzv0roemp8Y+iIxI3Ih5ecyukqELQEGzZlYiWg==
```

å°†å®ƒæ›¿æ¢åˆ° `obfuscatedClientSecret` é‡Œã€‚

å¦‚æœä½ ä¿®æ”¹äº† `redirectUri` ä¸ºå…¶ä»–å€¼ï¼Œä½ ä¹Ÿè¦åœ¨ `api.config.js` é‡Œè®¾ç½®å¥½ã€‚

<Callout emoji="ğŸ—£">
  è¯¦æƒ…è¯·å‚è€ƒ [å…³äºä½¿ç”¨è‡ªå·±çš„ secret è¿›è¡Œ AES åŠ å¯†æ–¹å¼çš„å°ç™½è§£å†³åŠæ³•](https://github.com/spencerwooo/onedrive-vercel-index/discussions/234)ã€‚
</Callout>

## è‡ªå®šä¹‰åŸŸå

è¯¦æƒ…è¯·å‚è€ƒ [Custom Domains - Vercel](https://vercel.com/docs/concepts/projects/custom-domains)ã€‚
