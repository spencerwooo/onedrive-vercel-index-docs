import Callout from 'nextra-theme-docs/callout'

# ç«‹å³ä¸Šæ‰‹

## å¤ªé•¿ä¸çœ‹ç‰ˆ

<Callout emoji="âš¡ï¸">è¿™æ˜¯ä¸€ä¸ªç®€çŸ­çš„æ„å»ºä½ è‡ªå·±çš„ onedrive-vercel-index çš„æŒ‡å¯¼ã€‚</Callout>

1. Fork [æ­¤é¡¹ç›®](https://github.com/spencerwooo/onedrive-vercel-index)ã€‚
2. å°† `site.config.js` é‡Œçš„ `userPrincipleName` æ”¹ä¸ºä½ çš„å¾®è½¯è´¦æˆ·é‚®ç®±ã€‚
3. å°† `site.config.js` é‡Œçš„ `baseDirectory` ä¿®æ”¹ä¸ºä½ è¦åˆ†äº«çš„æ–‡ä»¶å¤¹è·¯å¾„ã€‚
4. æ ¹æ®ä½ çš„ OneDrive ç‰ˆæœ¬ç¤ºæƒ…å†µä¿®æ”¹ `api.config.js`ã€‚
5. å°†ä½ çš„é¡¹ç›®å¯¼å…¥åˆ° Vercel å¹¶ [æ·»åŠ  Upstash æ’ä»¶](https://vercel.com/integrations/upstash) ä»¥æ›´æ–¹ä¾¿åœ°è®¾ç½® `REDIS_URL` ç¯å¢ƒå˜é‡ã€‚
6. éƒ¨ç½²ï¼Œå¹¶äº«å—ï¼ ğŸ‰

éƒ¨ç½²å®Œæˆåçš„é¡¹ç›®ä¼šå¼•å¯¼ä½ è¿›è¡Œ OAuth æ­¥éª¤ï¼Œå¹¶è‡ªåŠ¨å°†æ‰€éœ€çš„å‡­è¯å­˜å‚¨åˆ° Redis æ•°æ®åº“é‡Œã€‚è¿™å°±æ˜¯æˆ‘ä»¬è¦åšçš„å…¨éƒ¨äº‹æƒ…ï¼

## ç«‹å³ä¸Šæ‰‹ï¼ˆè¦æ¥çœŸçš„äº†ï¼ï¼‰

ä½¿ç”¨ onedrive-vercel-index æ¥å…±äº«ã€é¢„è§ˆä½ çš„ OneDrive é‡Œçš„æ–‡ä»¶ã€è§†é¢‘ã€éŸ³é¢‘ã€æ–‡æ¡£ï¼Œå¹¶æä¾›ä¸‹è½½ã€‚

![Screenshots of onedrive-vercel-index on multiple platforms](./_images/getting-started/od-vercel-idx.png)

onedrive-vercel-index æœ¬è´¨ä¸Šå°±æ˜¯ç”± Next.js æ„å»ºçš„æ¨¡æ¿ï¼Œä½ å¯ä»¥å°†å…¶å…è´¹éƒ¨ç½²åœ¨ Vercelã€Netlify æˆ–è€…å…¶ä»–æ‰˜ç®¡å¹³å°ä¸Šã€‚ä¸‹é¢æˆ‘ä»¬å°† **å®Œå…¨ä»å¤´å¼€å§‹** åˆ›å»ºä½ è‡ªå·±çš„ onedrive-vercel-indexã€‚

<Callout emoji="âš ï¸" type="warning">
  å¦‚æœä½ åœ¨ 2022 å¹´ä¹‹å‰éƒ¨ç½²è¿‡æ­¤é¡¹ç›®ï¼Œè¯·å‚è€ƒ [è¿ç§»åˆ° 2022 å¹´çš„æ–°ç‰ˆæœ¬](./migration/if-you-deployed-before-2022)ã€‚
</Callout>

## Fork æ­¤é¡¹ç›®

å°†æ­¤é¡¹ç›® Fork åˆ°ä½ è‡ªå·±çš„ GitHub è´¦æˆ·ä¸­ï¼Œå› ä¸ºä½ ä¼šéœ€è¦ç»´æŠ¤ä¸€ä¸ªåŒ…å«ä½ è‡ªå·±é…ç½®çš„é¡¹ç›®ã€‚

![Fork the repo to your own GitHub account](./_images/getting-started/fork-repo.png)

## ä¿®æ”¹è®¾ç½®

æœ‰äº›è®¾ç½®æ˜¯éœ€è¦ä¿®æ”¹çš„ã€‚é¡¹ç›®åŒ…æ‹¬ä¸¤ä¸ªé…ç½®æ–‡ä»¶ï¼Œåˆ†åˆ«æ˜¯ `config/site.config.js` ä¸ `config/api.config.js`ã€‚å‰è€…æ˜¯ç”¨æ¥å®šåˆ¶ä½ çš„ç½‘é¡µçš„ï¼Œåè€…é‚£ä¸ªæ˜¯ç”¨æ¥å®šä¹‰ API å‚æ•°çš„ã€‚

### å®¢åˆ¶åŒ–ç½‘ç«™

è¯·æ ¹æ®è‡ªèº«æƒ…å†µä¿®æ”¹ [`config/site.config.js`](https://github.com/spencerwooo/onedrive-vercel-index/blob/main/config/site.config.js)ï¼š

- `userPrincipalName` - æ˜¯ç”¨æ¥åœ¨ OAuth æ­¥éª¤æ—¶è®¤è¯ä½ çš„ä¸ªäººä¿¡æ¯çš„ã€‚é€šå¸¸æ˜¯ä½ çš„ **å¾®è½¯è´¦æˆ·é‚®ç®±**ã€‚
- `baseDirectory` - æ˜¯ä½ è¦åˆ†äº«çš„ OneDrive ç›®å½•ã€‚ä½ å¿…é¡»ä¿è¯æ­¤ç›®å½•æœ‰æ•ˆä¸”ä¸æ­¤å‚æ•°ä¸€è‡´ã€‚ï¼ˆä½ å¯ä»¥ç›´æ¥åœ¨ OneDrive å†…åˆ›å»ºä¸€ä¸ªå«åš `Public` æ–‡ä»¶å¤¹ï¼Œå¹¶å°†æ­¤é¡¹è®¾ç½®ä¸º `/Public`ã€‚ï¼‰

![You must change these two configs for your deployment to work](./_images/getting-started/change-site-config-js.png)

<Callout emoji="ğŸ€">æœ‰äº›è®¾ç½®æ˜¯ä¸ºä½ è‡ªå®šä¹‰è‡ªå·±çš„ç½‘é¡µè€Œå‡†å¤‡çš„ï¼Œè¯¦æƒ…è¯·å‚è€ƒ [è‡ªå®šä¹‰é…ç½®](./custom-configs)ã€‚</Callout>

### ä¿®æ”¹ API å‚æ•°ï¼ˆå¯é€‰é¡¹ï¼‰

å¦‚æœâ€¦â€¦

- ä½ æ˜¯ **OneDrive å›½é™…ç‰ˆç”¨æˆ·**ï¼ˆä¸æ˜¯ OneDrive ä¼ä¸šç‰ˆæˆ–æ•™è‚²ç‰ˆï¼Œä¸æ˜¯ SharePoint ç”¨æˆ·ï¼Œä¸æ˜¯ E5 è®¢é˜…ç”¨æˆ·ï¼‰ï¼Œè¯·ç›´æ¥å¿½ç•¥æ­¤æ­¥éª¤ï¼Œä¸è¦ç¢° `config/api.config.js`ã€‚

å¦‚æœä¸æ˜¯ï¼Œ**æˆ–è€…ä½ è‡ªå·±è§‰å¾—çœŸçš„æœ‰å¿…è¦ä¿®æ”¹**ï¼š

- OneDrive ä¸–çºªäº’è”ä½¿ç”¨äº†ä¸åŒçš„ API å‚æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ä¿®æ”¹ `authApi` å’Œ `driveApi`

  ![Change authApi and driveApi only if you are a SharePoint user](./_images/getting-started/change-api-config-js.png)

  å°†å®ƒä»¬ä¿®æ”¹ä¸ºï¼š

  ```js
  authApi: "https://login.partner.microsoftonline.cn/common/oauth2/v2.0/token",
  driveApi: "https://microsoftgraph.chinacloudapi.cn/v1.0/me/drive",
  ```

  {/* å¦‚æœä½ éœ€è¦ä½¿ç”¨ä»£ç†ä¸‹è½½åŠŸèƒ½ï¼Œè¯·ä¿®æ”¹ `directLinkRegex`ã€‚è¯¦æƒ…è¯·å‚è€ƒ [Proxied download (disabled)](). */}

- OneDrive ä¼ä¸šç‰ˆã€æ•™è‚²ç‰ˆä»¥åŠ E5 è®¢é˜…çš„ç”¨æˆ·éœ€è¦æ³¨æ„ï¼šå…ˆå°è¯•åœ¨ä¸ä¿®æ”¹ `config/api.config.js` çš„æƒ…å†µä¸‹è¿›è¡Œ OAuth **æ— è®ºä½ æ˜¯å¦æœ‰ç®¡ç†æƒé™**ã€‚å¦‚æœä½ è¢«å‘ŠçŸ¥éœ€è¦ç®¡ç†æƒé™ï¼Œä½ å°±è¦ä½¿ç”¨ä½ è‡ªå·±çš„ `clientId` ä¸ `clientSecret` äº†ã€‚è¯¦æƒ…è¯·å‚è€ƒ [ä½¿ç”¨ä½ è‡ªå·±çš„ clientid ä¸ secret](./advanced)ã€‚

## å¯¼å…¥åˆ° Vercel å¹¶éƒ¨ç½²

åœ¨ Vercel å¯¼å…¥ **ä½ è‡ªå·±çš„** onedrive-vercel-index GitHub é¡¹ç›®ï¼Œå¹¶è¿›è¡Œä»¥ä¸‹è®¾ç½®ï¼š

- ä¿®æ”¹ Build command ä¸º `pnpm build`.
- ä¿®æ”¹ Install command ä¸º `pnpm install`.

<Callout>é»˜è®¤çš„ä¹Ÿè®¸èƒ½æ­£å¸¸å·¥ä½œï¼Œä½†æœ€å¥½è¿˜æ˜¯è‡ªå®šä¹‰è¿™ä¸€é¡¹ç›®ã€‚</Callout>

![Import the forked GitHub project into Vercel](./_images/getting-started/import-to-vercel.png)

ç„¶åç‚¹å‡»éƒ¨ç½²ï¼ŒVercel å°†ä¼šä¸‹è½½ä½ çš„é¡¹ç›®å¹¶è¿›è¡Œéƒ¨ç½²ã€‚è¿™æ¬¡éƒ¨ç½²æœ‰å¯èƒ½ä¼šå¤±è´¥ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰è®¾å®š `REDIS_URL` ç¯å¢ƒå˜é‡ã€‚è¿™å°±æ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥è¦åšçš„ã€‚

### è¿æ¥åˆ° Redis

åˆ›å»ºä¸€ä¸ª Redis æ•°æ®åº“ï¼Œå¹¶ä¸”å°†æ•°æ®åº“çš„è®¿é—®é“¾æ¥å¡«å†™åˆ° Vercel çš„ `REDIS_URL` ç¯å¢ƒå˜é‡é‡Œã€‚Redis æ•°æ®åº“æ˜¯ç”¨äºå­˜å‚¨åœ¨ OAuth æ—¶è·å–çš„ `access_tokens` ä¸ `refresh_tokens` çš„ã€‚

- æˆ‘ä»¬æ¨èä½¿ç”¨ **Upstash** ï¼Œå®ƒå®Œå…¨å…è´¹ï¼Œå¹¶ä¸”ä¸ Vercel æ·±åº¦åˆä½œï¼Œè¯¦æƒ…è¯·å‚è€ƒ [Vercel Integration](https://docs.upstash.com/redis/howto/vercelintegration)ã€‚ï¼ˆè¯·å¿½ç•¥æœ€åä¸€æ­¥æ—¶è®©ä½  _Create Your Redis Client_ ï¼Œonedrive-vercel-index å·²ç»ä¸ºä½ å¤„ç†å¥½äº†ï¼‰ã€‚
- ä½ å¯ä»¥ä½¿ç”¨ä½ è‡ªå·±çš„ Redis æ•°æ®åº“ï¼Œåªè¦æœ‰ Vercel èƒ½ç”¨çš„è®¿é—®é“¾æ¥å°±è¡Œã€‚

æ— è®ºä½ ç”¨ä»€ä¹ˆæ–¹å¼ï¼Œä½ åº”è¯¥åœ¨ Vercel çš„ `REDIS_URL` ç¯å¢ƒå˜é‡é‡Œå¡«å¥½ä¸€ä¸ªç±»ä¼¼è¿™æ ·çš„ Redis URLï¼š

```
redis://:xxx...@some-thing-like-35533.upstash.io:35533
```

å¦‚æœä½ ä¸º Redis æ•°æ®åº“å¯ç”¨äº† [ä¼ è¾“åŠ å¯†](https://docs.upstash.com/redis/howto/connectwithtls)ï¼š

```
rediss://:xxx...@some-thing-like-35533.upstash.io:35533
```

![Using Upstash as the free Redis database for onedrive-vercel-index](./_images/getting-started/upstash-redis.png)

### é‡æ–°éƒ¨ç½²

æœ€åï¼Œé‡æ–°è¿›è¡Œä¸€æ¬¡éƒ¨ç½²ã€‚å¹¶åœ¨éƒ¨ç½²å®Œæˆåè®¿é—® Vercel æä¾›çš„é“¾æ¥ï¼Œ`onedrive-vercel-index` å°†ä¼šå¼•å¯¼ä½ è¿›è¡Œ OAuth è®¤è¯ã€‚ä½ ä¹Ÿå¯ä»¥åœ¨ Vercel è‡ªå®šä¹‰è®¿é—®é“¾æ¥ï¼Œè¯¦æƒ…è¯·å‚è€ƒ [è‡ªå®šä¹‰åŸŸå](./advanced)ã€‚

![Checking the deployed domain and navigate to the live site](./_images/getting-started/check-deployed-domain.png)

## è¿›è¡Œè®¤è¯

è®¿é—®ä½ çš„ `onedrive-vercel-index` ï¼Œå¦‚æœä½ ä»æœªè¿›è¡Œè®¤è¯ï¼ŒOAuth è®¤è¯å°†ä¼šè‡ªåŠ¨å¼€å§‹ã€‚

### ç¬¬ä¸€æ­¥ - å‡†å¤‡å·¥ä½œ

![Step 1 - preparing for authentication](./_images/getting-started/step1-preparations.png)

æ£€æŸ¥æ­¤é¡µé¢ä¸Šçš„å‚æ•°æ˜¯å¦æ­£ç¡®ï¼Œå°¤å…¶æ˜¯ `client_id` ä¸ `client_secret` ï¼ˆåŠ å¯†çš„ï¼‰ï¼Œä»–ä»¬åº”è¯¥ä¸ä½ çš„é¡¹ç›®é‡Œçš„ä¸€è‡´ã€‚ä½ è¿˜è¦æ£€æŸ¥ä¸€ä¸‹ API æƒé™ï¼Œåº”è¯¥åªéœ€è¦è¿™ä¸‰ä¸ªï¼š

- `user.read`: åœ¨è¿›è¡Œ OAuth æ—¶è®¤è¯ä½ çš„èº«ä»½ï¼Œé˜²æ­¢æŸäº›å‚»é€¼é€šè¿‡é‡æ–°è®¤è¯é›·æ™®ä½ çš„é¡¹ç›®ã€‚
- `files.read.all`: ç”¨äºè®¿é—®ä½ çš„ OneDrive çš„æ–‡ä»¶
- `offline_access`: å°±æ˜¯â€¦â€¦ç”¨æ¥ç¦»çº¿è®¿é—® ğŸ™ƒ

å¦‚æœä¸€åˆ‡éƒ½å‡†å¤‡å¥½äº†ï¼Œå°±æ¥åˆ°ç¬¬äºŒæ­¥ã€‚å¦‚æœæœ‰äº›ä»€ä¹ˆå·®é”™ï¼Œæ£€æŸ¥ä½ çš„ `config/api.config.js` ç„¶åé‡æ–°éƒ¨ç½²ã€‚

### ç¬¬äºŒæ­¥ - è·å–è®¤è¯ç 

![Step 2 - getting the authorisation code](./_images/getting-started/step2-get-auth-code.png)

æˆ‘ä»¬å·²ç»åŸºäº `config/api.config.js` ç»™ä½ å‡†å¤‡å¥½è®¤è¯é“¾æ¥äº†ã€‚ç‚¹å‡»é“¾æ¥ï¼Œä½ å°†ä¼šè¿›å…¥ä¸€ä¸ªæ–°æ ‡ç­¾é¡µå¹¶è¿›è¡Œç™»å½•ã€‚è¯·ç¡®ä¿ä½ ç™»é™†çš„è´¦æˆ·ä¸ä½ åœ¨ `config/site.config.js` çš„ `userPrincipalName` é‡Œè®¾ç½®çš„ä¸€è‡´ã€‚

<Callout emoji="âš ï¸" type="warning">
  å¦‚æœä½ çš„å¸æˆ·æ²¡æœ‰ç®¡ç†æƒé™ï¼Œé‚£ä¹ˆä½ éœ€è¦ä½¿ç”¨ä½ è‡ªå·±çš„ `client_id` ä¸ `client_secret`ã€‚è¯¦æƒ…è¯·å‚è€ƒ [ä½¿ç”¨ä½ è‡ªå·±çš„ clientid ä¸
  secret](./advanced)ã€‚
</Callout>

![The [localhost](http://localhost) URL that you would be redirected to](./_images/getting-started/step2-redirect-code-localhost.png)

å®Œæˆç™»å½•åï¼Œä½ å°†ä¼šè·³è½¬åˆ° `http://localhost` ï¼Œå°½ç®¡å®ƒæ˜¾ç¤ºæ— æ³•è®¿é—®ï¼Œä½ åªéœ€è¦å¤åˆ¶åœ°å€æ ä¸­çš„åœ°å€ç„¶åç²˜è´´åˆ°ç¬¬äºŒæ­¥çš„è¾“å…¥æ¡†é‡Œã€‚onedrive-vercel-index ä¼šè‡ªåŠ¨è¯†åˆ«ç”¨äºè·å– `access_token` ä¸ `refresh_token` çš„è®¤è¯ç ï¼Œç„¶åç‚¹å‡» _Get tokens_ å°±è¡Œã€‚

### ç¬¬ä¸‰æ­¥ - è·å–å‡­è¯

![Success! We have acquired the tokens that are needed](./_images/getting-started/step3-get-tokens.png)

ä½ åªéœ€è¦ç­‰å¾…å‡ ç§’é’Ÿï¼Œé¡µé¢ä¸Šå°±ä¼šæ˜¾ç¤ºæˆåŠŸæç¤ºä»¥åŠå‡ è¡Œå‡­è¯ï¼Œè¯·ç‚¹å‡» _Store tokens_ ï¼Œä½ çš„å‡­è¯å°±ä¼šä¿å­˜åˆ° Redis æ•°æ®åº“é‡Œã€‚

<Callout emoji="ğŸ“¢">
  è¿™ä¸ªè¿‡ç¨‹ä¸­æˆ‘ä»¬ä¸€ç›´åœ¨æ£€æŸ¥ **ä½ çš„èº«ä»½** ï¼Œæ‰€ä»¥å¦‚æœå‡ºç°äº† "Don't pretend to be the site owner" æç¤ºï¼Œè¯·æ£€æŸ¥
  `config/site.config.js` é‡Œçš„ `userPrincipalName`æ˜¯å¦å¡«å†™æ­£ç¡®ã€‚
</Callout>

æœ€åï¼Œä½ å°†ä¼šè·³è½¬åˆ°ä½ å…¨æ–°çš„ onedrive-vercel-index ï¼Œå®Œæˆï¼

<Callout emoji="âš ï¸" type="warning">
  å¦‚æœä½ è®¤è¯ç»“æŸåè¢«é‡æ–°è·³è½¬åˆ°æ­¥éª¤ä¸€ï¼Œè€Œä½ ç¡®è®¤ä¸€åˆ‡éƒ½æ²¡æœ‰é—®é¢˜æ—¶ï¼Œ**è¯·ç­‰å¾…å‡ ç§’å¹¶æ‰‹åŠ¨å›åˆ°ä¸»é¡µå†åˆ·æ–°**ï¼ŒRedis æ•°æ®åº“å­˜å–å‡­è¯éœ€è¦ä¸€ç‚¹å„¿æ—¶é—´ã€‚
</Callout>
